# Nginx server snippet for digipeak.site (include in your site server block)

# Redirect HTTP to HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name digipeak.site www.digipeak.site;
    return 301 https://digipeak.site$request_uri;
}

# HTTPS server
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name digipeak.site www.digipeak.site;

    root /var/www/digipeak; # adjust to your path
    index index.html;

    # TLS settings
    ssl_certificate     /etc/letsencrypt/live/digipeak.site/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/digipeak.site/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305';
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:10m;

    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # Security headers
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), bluetooth=()" always;
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Cross-Origin-Resource-Policy "same-origin" always;

    # CSP - start in Report-Only mode to ensure nothing breaks
    add_header Content-Security-Policy-Report-Only "default-src 'self'; script-src 'self' https://cdn.jsdelivr.net https://unpkg.com 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com; img-src 'self' data: https:; font-src 'self' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net data:; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'" always;

    # Gzip/Brotli (if compiled)
    gzip on;
    gzip_types text/plain text/css application/javascript application/json image/svg+xml;

    # Static caching
    location ~* \.(css|js)$ { expires 7d; add_header Cache-Control "public"; }
    location ~* \.(png|jpg|jpeg|gif|svg|webp|ico)$ { expires 30d; add_header Cache-Control "public"; }

    # Prevent access to sensitive files
    location ~ /\.(git|hg|svn) { deny all; }
    location ~* \.(env|bak|sql|zip)$ { deny all; }

    # Disable directory listing
    autoindex off;

    # Rate limit example (POST endpoints)
    limit_req_zone $binary_remote_addr zone=post_zone:10m rate=10r/m;
    location / {
        try_files $uri $uri/ =404;
        # Apply rate limiting to POST only
        if ($request_method = POST) {
            limit_req zone=post_zone burst=20 nodelay;
        }
    }
}
