# Apache .htaccess hardening for digipeak.site (place in web root)

# Force HTTPS with 301 (requires mod_rewrite)
RewriteEngine On
RewriteCond %{HTTPS} !=on [OR]
RewriteCond %{HTTP_HOST} !^digipeak\.site$ [NC]
RewriteRule ^(.*)$ https://digipeak.site/$1 [R=301,L]

# Security headers
<IfModule mod_headers.c>
  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
  # Start with Report-Only to avoid breakage; move to enforce after validation
  Header always set Content-Security-Policy-Report-Only "default-src 'self'; script-src 'self' https://cdn.jsdelivr.net https://unpkg.com 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com; img-src 'self' data: https:; font-src 'self' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net data:; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'"
  Header always set X-Frame-Options "DENY"
  Header always set X-Content-Type-Options "nosniff"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), bluetooth=()"
  Header always set Cross-Origin-Opener-Policy "same-origin"
  Header always set Cross-Origin-Resource-Policy "same-origin"
  # Header always set Expect-CT "max-age=86400, enforce"
</IfModule>

# Prevent access to hidden and sensitive files
<FilesMatch "^(\.|composer\.|env|.*\.env|package|webpack|Gruntfile|gulpfile|Vagrantfile|Dockerfile|Makefile|README|LICENSE|backup|dump|.*\.sql|.*\.bak|.*\.zip)$">
  Require all denied
</FilesMatch>

# Block VCS and config directories
RedirectMatch 404 /\.git
RedirectMatch 404 /\.hg
RedirectMatch 404 /\.svn

# Disable directory listing
Options -Indexes

# MIME type sniffing protections
AddType application/javascript js
AddType text/css css

# Caching (tune as needed)
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType text/css "access plus 7 days"
  ExpiresByType application/javascript "access plus 7 days"
  ExpiresByType image/png "access plus 30 days"
  ExpiresByType image/jpeg "access plus 30 days"
  ExpiresByType image/webp "access plus 30 days"
  ExpiresByType image/svg+xml "access plus 30 days"
  ExpiresByType image/gif "access plus 30 days"
</IfModule>

# Compression (requires mod_deflate/brotli)
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/javascript application/json image/svg+xml
</IfModule>
# If Brotli available
# <IfModule mod_brotli.c>
#   BrotliCompressionQuality 5
#   AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/xml text/css application/javascript application/json image/svg+xml
# </IfModule>
